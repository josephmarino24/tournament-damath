<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damath - Tournament Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f8fafc; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            border: 12px solid #1e293b;
            background-color: #1e293b;
            border-radius: 12px;
        }
        .cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .cell.dark { background-color: #2d5a27; color: rgba(255,255,255,0.2); }
        .cell.light { background-color: #f0f0d8; color: rgba(0,0,0,0.1); }
        .pitsa {
            width: 82%;
            height: 82%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 800;
            color: white;
            z-index: 10;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            position: relative;
        }
        .pitsa.blue { background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8); }
        .pitsa.red { background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c); }
        .pitsa.selected { transform: scale(1.1); outline: 4px solid #fbbf24; z-index: 20; }
        .pitsa.dama::after { content: '★'; position: absolute; top: -2px; right: -2px; color: #fbbf24; font-size: 1.2rem; text-shadow: 0 0 3px black; }
        .move-dot { width: 14px; height: 14px; background: rgba(251, 191, 36, 0.8); border-radius: 50%; border: 2px solid white; }
        
        #multiplayer-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="multiplayer-modal" class="p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full border border-slate-200">
            <h2 class="text-2xl font-black mb-1 text-slate-800 text-center">Multiplayer</h2>
            <p id="mp-status" class="text-[10px] font-bold uppercase tracking-widest text-orange-500 mb-6 text-center">Connecting to Server...</p>
            
            <div id="mp-controls">
                <button onclick="hostGame()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black mb-3 hover:bg-blue-700 transition-all active:scale-95">Host Match</button>
                <input type="text" id="join-code" placeholder="6-digit code" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-2 text-center font-mono text-xl uppercase" maxlength="6">
                <button onclick="joinGame()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black hover:bg-slate-700 active:scale-95">Join Match</button>
            </div>

            <div id="mp-waiting" class="hidden text-center">
                <p class="text-slate-500 text-sm mb-2">Room Code:</p>
                <h3 id="display-code" class="text-4xl font-mono font-black text-blue-600 mb-6">------</h3>
                <button onclick="cancelMultiplayer()" class="text-red-500 font-bold text-xs uppercase">Cancel</button>
            </div>
            
            <button onclick="skipConnection()" class="w-full mt-6 text-slate-400 text-[10px] uppercase font-black tracking-widest hover:text-blue-500 transition-colors">⚠️ Play Offline (Skip Server)</button>
        </div>
    </div>

    <div class="w-full max-w-5xl flex flex-col gap-6">
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter">DAMATH</h1>
                <div id="connection-pill" class="px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-black rounded-full uppercase">Checking...</div>
            </div>
            
            <div class="flex gap-4 mt-4 md:mt-0">
                <div id="card1" class="text-center bg-blue-50 p-3 rounded-2xl border-2 border-blue-200 min-w-[90px]">
                    <div class="text-[10px] font-black text-blue-500 uppercase">Blue</div>
                    <div id="score1" class="text-2xl font-black">0</div>
                </div>
                <div id="card2" class="text-center bg-red-50 p-3 rounded-2xl border-2 border-transparent min-w-[90px]">
                    <div class="text-[10px] font-black text-red-500 uppercase">Red</div>
                    <div id="score2" class="text-2xl font-black">0</div>
                </div>
                <div class="text-center bg-slate-900 text-white p-3 rounded-2xl min-w-[90px]">
                    <div class="text-[10px] font-black text-slate-400 uppercase">Timer</div>
                    <div id="timer" class="text-2xl font-mono font-black">20:00</div>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 items-start">
            <div id="board" class="board-grid shadow-2xl mx-auto"></div>
            
            <div class="w-full lg:w-72 space-y-4">
                <div id="turn-box" class="bg-blue-600 text-white p-6 rounded-[2rem] text-center shadow-lg transition-all">
                    <p class="text-xs font-black uppercase tracking-widest opacity-70">Current Turn</p>
                    <h2 id="turn-text" class="text-2xl font-black">Blue</h2>
                </div>
                
                <button onclick="openModal()" id="online-btn" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all active:scale-95 text-sm uppercase tracking-widest">
                    Multiplayer
                </button>

                <button onclick="resetGame()" class="w-full bg-white text-slate-400 py-4 rounded-[2rem] border border-slate-200 font-bold text-xs uppercase hover:bg-slate-50">
                    Reset Board
                </button>

                <div class="bg-slate-100 p-4 rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Rules</p>
                    <p class="text-[11px] text-slate-600 leading-relaxed italic">
                        "Forced Capture" is active. You must take an opponent's piece if the move is available.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'damath-tournament';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        let db, auth;
        let boardState = [];
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let selectedPiece = null;
        let validMoves = [];
        let timer = 1200;
        let matchId = null;
        let myPlayerNum = null;
        let isOnline = false;

        const operators = [
            ['', '+', '', '-', '', 'x', '', '÷'],
            ['÷', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', '÷'],
            ['÷', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', '÷'],
            ['÷', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', '÷'],
            ['÷', '', 'x', '', '-', '', '+', '']
        ];

        window.onload = () => {
            initGame();
            if (firebaseConfig) {
                connectFirebase();
            } else {
                setOffline();
            }
            
            // Auto-fallback timer
            setTimeout(() => {
                if (!isOnline) {
                    setOffline();
                }
            }, 5000);
        };

        function setOffline() {
            const status = document.getElementById('mp-status');
            status.innerText = "Offline Mode Active";
            status.className = "text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-6 text-center";
            const pill = document.getElementById('connection-pill');
            pill.innerText = "Offline";
            pill.className = "px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-black rounded-full uppercase";
            isOnline = false;
        }

        async function connectFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                
                await initAuth();
                isOnline = true;
                const pill = document.getElementById('connection-pill');
                pill.innerText = "Online";
                pill.className = "px-3 py-1 bg-green-100 text-green-600 text-[10px] font-black rounded-full uppercase";
                document.getElementById('mp-status').innerText = "Connected - Ready to Play";
                document.getElementById('mp-status').className = "text-[10px] font-bold uppercase tracking-widest text-green-500 mb-6 text-center";
            } catch (e) {
                console.error("Firebase connection failed", e);
                setOffline();
            }
        }

        function skipConnection() {
            setOffline();
            closeModal();
        }

        function initGame() {
            timer = 1200;
            currentPlayer = 1;
            scores = { 1: 0, 2: 0 };
            boardState = Array(8).fill(null).map(() => Array(8).fill(null));
            const setup = [
                {r:0,c:1},{r:0,c:3},{r:0,c:5},{r:0,c:7},
                {r:1,c:0},{r:1,c:2},{r:1,c:4},{r:1,c:6},
                {r:2,c:1},{r:2,c:3},{r:2,c:5},{r:2,c:7},
                {r:5,c:0},{r:5,c:2},{r:5,c:4},{r:5,c:6},
                {r:6,c:1},{r:6,c:3},{r:6,c:5},{r:6,c:7},
                {r:7,c:0},{r:7,c:2},{r:7,c:4},{r:7,c:6}
            ];
            setup.forEach(p => {
                const val = Math.floor(Math.random() * 12) * (Math.random() > 0.5 ? 1 : -1);
                boardState[p.r][p.c] = { val, player: p.r < 3 ? 2 : 1, isDama: false };
            });
            render();
            setInterval(() => {
                if (timer > 0) {
                    timer--;
                    const m = Math.floor(timer/60), s = timer%60;
                    document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                }
            }, 1000);
        }

        function calculateMoves(r, c) {
            const piece = boardState[r][c];
            if (!piece) return [];
            const moves = [];
            const dirs = [[-1, -1], [-1, 1], [1, -1], [1, 1]];
            
            if (piece.isDama) {
                dirs.forEach(d => {
                    let nr = r + d[0], nc = c + d[1], foundEnemy = false, enemyPos = null;
                    while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                        const target = boardState[nr][nc];
                        if (!foundEnemy) {
                            if (!target) moves.push({ r: nr, c: nc });
                            else if (target.player !== piece.player) { foundEnemy = true; enemyPos = { r: nr, c: nc }; }
                            else break;
                        } else {
                            if (!target) moves.push({ r: nr, c: nc, capture: enemyPos });
                            else break;
                        }
                        nr += d[0]; nc += d[1];
                    }
                });
            } else {
                const moveDirs = piece.player === 1 ? [[-1, -1], [-1, 1]] : [[1, -1], [1, 1]];
                moveDirs.forEach(d => {
                    let nr = r + d[0], nc = c + d[1];
                    if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && !boardState[nr][nc]) moves.push({ r: nr, c: nc });
                });
                dirs.forEach(d => {
                    let nr = r + d[0], nc = c + d[1], jr = r + d[0]*2, jc = c + d[1]*2;
                    if (jr >= 0 && jr < 8 && jc >= 0 && jc < 8 && boardState[nr][nc] && boardState[nr][nc].player !== piece.player && !boardState[jr][jc]) {
                        moves.push({ r: jr, c: jc, capture: { r: nr, c: nc } });
                    }
                });
            }
            return moves;
        }

        function handleCellClick(r, c) {
            if (matchId && myPlayerNum !== currentPlayer) return;
            const piece = boardState[r][c];
            if (piece && piece.player === currentPlayer) {
                selectedPiece = { r, c };
                validMoves = calculateMoves(r, c);
                // Forced Capture Logic
                let hasGlobalCapture = false;
                for(let i=0; i<8; i++) for(let j=0; j<8; j++) {
                    if(boardState[i][j]?.player === currentPlayer && calculateMoves(i,j).some(m => m.capture)) hasGlobalCapture = true;
                }
                if (hasGlobalCapture) validMoves = validMoves.filter(m => m.capture);
                render();
            } else if (selectedPiece) {
                const move = validMoves.find(m => m.r === r && m.c === c);
                if (move) executeMove(selectedPiece.r, selectedPiece.c, r, c, move.capture);
            }
        }

        async function executeMove(fR, fC, tR, tC, capture) {
            const piece = boardState[fR][fC];
            if (capture) {
                const enemy = boardState[capture.r][capture.c];
                const op = operators[tR][tC];
                let pts = 0;
                if (op === '+') pts = piece.val + enemy.val;
                else if (op === '-') pts = piece.val - enemy.val;
                else if (op === 'x') pts = piece.val * enemy.val;
                else if (op === '÷') pts = enemy.val !== 0 ? Math.floor(piece.val / enemy.val) : 0;
                scores[currentPlayer] += pts * (piece.isDama ? 2 : 1);
                boardState[capture.r][capture.c] = null;
            }
            boardState[tR][tC] = piece;
            boardState[fR][fC] = null;
            if (!piece.isDama && ((currentPlayer === 1 && tR === 0) || (currentPlayer === 2 && tR === 7))) piece.isDama = true;

            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedPiece = null;
            validMoves = [];
            
            if (matchId && db) {
                await db.doc(`artifacts/${appId}/public/data/matches/${matchId}`).update({
                    board: JSON.stringify(boardState),
                    scores,
                    currentPlayer
                }).catch(e => console.warn("Update skipped (offline/local)"));
            }
            render();
        }

        function render() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r + c) % 2 !== 0 ? 'dark' : 'light'}`;
                    cell.innerText = operators[r][c];
                    cell.onclick = () => handleCellClick(r, c);
                    const p = boardState[r][c];
                    if (p) {
                        const pDiv = document.createElement('div');
                        pDiv.className = `pitsa ${p.player === 1 ? 'blue' : 'red'} ${p.isDama ? 'dama' : ''}`;
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) pDiv.classList.add('selected');
                        pDiv.innerText = p.val;
                        cell.appendChild(pDiv);
                    }
                    if (validMoves.some(m => m.r === r && m.c === c)) {
                        const dot = document.createElement('div');
                        dot.className = 'move-dot';
                        cell.appendChild(dot);
                    }
                    board.appendChild(cell);
                }
            }
            document.getElementById('score1').innerText = scores[1];
            document.getElementById('score2').innerText = scores[2];
            document.getElementById('turn-text').innerText = currentPlayer === 1 ? "Blue" : "Red";
            document.getElementById('turn-box').className = `p-6 rounded-[2rem] text-center shadow-lg transition-all ${currentPlayer === 1 ? 'bg-blue-600' : 'bg-red-600'}`;
            document.getElementById('card1').className = `text-center bg-blue-50 p-3 rounded-2xl border-2 min-w-[90px] ${currentPlayer === 1 ? 'border-blue-400 scale-105' : 'border-transparent'}`;
            document.getElementById('card2').className = `text-center bg-red-50 p-3 rounded-2xl border-2 min-w-[90px] ${currentPlayer === 2 ? 'border-red-400 scale-105' : 'border-transparent'}`;
        }

        // Multiplayer Handlers
        window.openModal = () => document.getElementById('multiplayer-modal').style.display = 'flex';
        window.closeModal = () => document.getElementById('multiplayer-modal').style.display = 'none';
        
        async function hostGame() {
            if (!isOnline) return alert("You are currently in Offline Mode. Please refresh to try reconnecting to the server.");
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            matchId = code; myPlayerNum = 1;
            document.getElementById('mp-controls').classList.add('hidden');
            document.getElementById('mp-waiting').classList.remove('hidden');
            document.getElementById('display-code').innerText = code;
            await db.doc(`artifacts/${appId}/public/data/matches/${code}`).set({
                board: JSON.stringify(boardState),
                scores: { 1: 0, 2: 0 },
                currentPlayer: 1,
                status: 'waiting'
            });
            listen(code);
        }

        async function joinGame() {
            if (!isOnline) return alert("You are currently in Offline Mode.");
            const code = document.getElementById('join-code').value.toUpperCase();
            if (code.length !== 6) return;
            matchId = code; myPlayerNum = 2;
            const ref = db.doc(`artifacts/${appId}/public/data/matches/${code}`);
            const snap = await ref.get();
            if (!snap.exists) return alert("Room not found");
            await ref.update({ status: 'active' });
            closeModal();
            listen(code);
        }

        function listen(code) {
            db.doc(`artifacts/${appId}/public/data/matches/${code}`).onSnapshot(doc => {
                const data = doc.data();
                if (data.status === 'active') closeModal();
                boardState = JSON.parse(data.board);
                scores = data.scores;
                currentPlayer = data.currentPlayer;
                render();
            });
        }
        
        function resetGame() { 
            if (matchId) {
                location.reload(); 
            } else {
                initGame();
            }
        }
        function cancelMultiplayer() { location.reload(); }
    </script>
</body>
</html>
