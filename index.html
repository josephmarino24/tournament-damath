<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Damath - Tournament Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f8fafc; margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .board-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1/1;
            border: 12px solid #1e293b;
            background-color: #1e293b;
            border-radius: 12px;
        }
        .cell {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .cell.dark { background-color: #2d5a27; color: rgba(255,255,255,0.2); }
        .cell.light { background-color: #f0f0d8; color: rgba(0,0,0,0.1); }
        .pitsa {
            width: 82%;
            height: 82%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 800;
            color: white;
            z-index: 10;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
            position: relative;
            transition: transform 0.2s;
        }
        .pitsa.blue { background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8); }
        .pitsa.red { background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c); }
        .pitsa.selected { transform: scale(1.1); outline: 4px solid #fbbf24; z-index: 20; }
        .pitsa.dama::after { content: 'โ'; position: absolute; top: -2px; right: -2px; color: #fbbf24; font-size: 1.2rem; text-shadow: 0 0 3px black; }
        .move-dot { width: 14px; height: 14px; background: rgba(251, 191, 36, 0.8); border-radius: 50%; border: 2px solid white; }
        
        #multiplayer-modal, #winner-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Multiplayer Modal -->
    <div id="multiplayer-modal" class="p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full border border-slate-200">
            <h2 class="text-2xl font-black mb-1 text-slate-800 text-center">Multiplayer</h2>
            <p id="mp-status" class="text-[10px] font-bold uppercase tracking-widest text-orange-500 mb-6 text-center">Connecting to Server...</p>
            
            <div id="mp-controls">
                <button onclick="hostGame()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black mb-3 hover:bg-blue-700 transition-all active:scale-95">Host Match</button>
                <input type="text" id="join-code" placeholder="6-digit code" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-2 text-center font-mono text-xl uppercase" maxlength="6">
                <button onclick="joinGame()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black hover:bg-slate-700 active:scale-95">Join Match</button>
            </div>

            <div id="mp-waiting" class="hidden text-center">
                <p class="text-slate-500 text-sm mb-2">Room Code:</p>
                <h3 id="display-code" class="text-4xl font-mono font-black text-blue-600 mb-6">------</h3>
                <button onclick="cancelMultiplayer()" class="text-red-500 font-bold text-xs uppercase">Cancel</button>
            </div>
            
            <button onclick="skipConnection()" class="w-full mt-6 text-slate-400 text-[10px] uppercase font-black tracking-widest hover:text-blue-500 transition-colors">โ๏ธ Play Offline (Skip Server)</button>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winner-modal" class="p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center border-4 border-yellow-400">
            <div class="text-5xl mb-4">๐</div>
            <h2 class="text-3xl font-black mb-2 text-slate-800" id="winner-title">Blue Wins!</h2>
            <p id="winner-stats" class="text-slate-500 mb-6 font-bold uppercase tracking-widest whitespace-pre-line">Final Score: 0 - 0</p>
            <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black hover:bg-slate-800 transition-all active:scale-95">New Match</button>
        </div>
    </div>

    <div class="w-full max-w-5xl flex flex-col gap-6">
        <div class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-[2rem] shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter">DAMATH</h1>
                <div id="connection-pill" class="px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-black rounded-full uppercase">Checking...</div>
            </div>
            
            <div class="flex gap-4 mt-4 md:mt-0">
                <div id="card1" class="text-center bg-blue-50 p-3 rounded-2xl border-2 border-blue-200 min-w-[90px]">
                    <div class="text-[10px] font-black text-blue-500 uppercase">Blue</div>
                    <div id="score1" class="text-2xl font-black">0</div>
                </div>
                <div id="card2" class="text-center bg-red-50 p-3 rounded-2xl border-2 border-transparent min-w-[90px]">
                    <div class="text-[10px] font-black text-red-500 uppercase">Red</div>
                    <div id="score2" class="text-2xl font-black">0</div>
                </div>
                <div class="text-center bg-slate-900 text-white p-3 rounded-2xl min-w-[90px]">
                    <div class="text-[10px] font-black text-slate-400 uppercase">Timer</div>
                    <div id="timer" class="text-2xl font-mono font-black">20:00</div>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8 items-start">
            <div id="board" class="board-grid shadow-2xl mx-auto"></div>
            
            <div class="w-full lg:w-72 space-y-4">
                <div id="turn-box" class="bg-blue-600 text-white p-6 rounded-[2rem] text-center shadow-lg transition-all">
                    <p class="text-xs font-black uppercase tracking-widest opacity-70">Current Turn</p>
                    <h2 id="turn-text" class="text-2xl font-black">Blue</h2>
                </div>
                
                <button onclick="openModal()" id="online-btn" class="w-full bg-indigo-600 text-white py-5 rounded-[2rem] font-black hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all active:scale-95 text-sm uppercase tracking-widest">
                    Multiplayer
                </button>

                <button onclick="resetGame()" class="w-full bg-white text-slate-400 py-4 rounded-[2rem] border border-slate-200 font-bold text-xs uppercase hover:bg-slate-50">
                    Reset Board
                </button>

                <div class="bg-slate-100 p-4 rounded-2xl">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Rules</p>
                    <p class="text-[11px] text-slate-600 leading-relaxed italic">
                        Forced capture is mandatory. Dama pieces can fly over empty tiles to capture. Timer is 20:00.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Updated Firebase Configuration from User
        const firebaseConfig = {
            apiKey: "AIzaSyA-_jkxLGS255XbhxYIm3WxS3wVOeD-cXE",
            authDomain: "tournament-damath.firebaseapp.com",
            projectId: "tournament-damath",
            storageBucket: "tournament-damath.firebasestorage.app",
            messagingSenderId: "994042280890",
            appId: "1:994042280890:web:78cf36127de438f731bb83",
            measurementId: "G-ER585Y49RN"
        };
        
        const appId = 'tournament-damath-v1';
        let db, auth;
        let boardState = [];
        let currentPlayer = 1;
        let scores = { 1: 0, 2: 0 };
        let selectedPiece = null;
        let validMoves = [];
        let timer = 1200; // 20 minutes
        let matchId = null;
        let myPlayerNum = null;
        let isOnline = false;
        let gameActive = true;
        let currentChainCapture = null;

        const operators = [
            ['', '+', '', '-', '', 'x', '', 'รท'],
            ['รท', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', 'รท'],
            ['รท', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', 'รท'],
            ['รท', '', 'x', '', '-', '', '+', ''],
            ['', '+', '', '-', '', 'x', '', 'รท'],
            ['รท', '', 'x', '', '-', '', '+', '']
        ];

        window.onload = () => {
            initGame();
            connectFirebase();
            setTimeout(() => { if (!isOnline) setOffline(); }, 8000);
        };

        function setOffline() {
            const status = document.getElementById('mp-status');
            if (status) status.innerText = "Offline Mode Active";
            const pill = document.getElementById('connection-pill');
            if (pill) {
                pill.innerText = "Offline";
                pill.className = "px-3 py-1 bg-slate-100 text-slate-500 text-[10px] font-black rounded-full uppercase";
            }
            isOnline = false;
        }

        async function connectFirebase() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // Sign in anonymously to enable Firestore access
                await auth.signInAnonymously();
                
                isOnline = true;
                const pill = document.getElementById('connection-pill');
                pill.innerText = "Online";
                pill.className = "px-3 py-1 bg-green-100 text-green-600 text-[10px] font-black rounded-full uppercase";
                document.getElementById('mp-status').innerText = "Connected - Ready to Play";
                document.getElementById('mp-status').className = "text-[10px] font-bold uppercase tracking-widest text-green-500 mb-6 text-center";
            } catch (e) {
                console.error("Firebase connection error:", e);
                setOffline();
            }
        }

        function skipConnection() { setOffline(); closeModal(); }

        function initGame() {
            timer = 1200;
            currentPlayer = 1;
            scores = { 1: 0, 2: 0 };
            gameActive = true;
            currentChainCapture = null;
            boardState = Array(8).fill(null).map(() => Array(8).fill(null));
            const setup = [
                {r:0,c:1},{r:0,c:3},{r:0,c:5},{r:0,c:7},
                {r:1,c:0},{r:1,c:2},{r:1,c:4},{r:1,c:6},
                {r:2,c:1},{r:2,c:3},{r:2,c:5},{r:2,c:7},
                {r:5,c:0},{r:5,c:2},{r:5,c:4},{r:5,c:6},
                {r:6,c:1},{r:6,c:3},{r:6,c:5},{r:6,c:7},
                {r:7,c:0},{r:7,c:2},{r:7,c:4},{r:7,c:6}
            ];
            setup.forEach(p => {
                const val = Math.floor(Math.random() * 12);
                boardState[p.r][p.c] = { val, player: p.r < 3 ? 2 : 1, isDama: false };
            });
            render();
            startTimer();
        }

        function startTimer() {
            const interval = setInterval(() => {
                if (!gameActive) return clearInterval(interval);
                if (timer > 0) {
                    timer--;
                    const m = Math.floor(timer/60), s = timer%60;
                    document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2,'0')}`;
                } else {
                    endGame("Time is up!");
                    clearInterval(interval);
                }
            }, 1000);
        }

        function endGame(reason) {
            gameActive = false;
            let winner = scores[1] > scores[2] ? "Blue" : "Red";
            if (scores[1] === scores[2]) winner = "Draw";
            
            document.getElementById('winner-modal').style.display = 'flex';
            document.getElementById('winner-title').innerText = winner === "Draw" ? "It's a Draw!" : `${winner} Wins!`;
            document.getElementById('winner-stats').innerText = `Final Score: Blue ${scores[1]} - Red ${scores[2]}\n${reason}`;
            syncOnline();
        }

        function checkPieceCounts() {
            let blueCount = 0, redCount = 0;
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                if(boardState[r][c]?.player === 1) blueCount++;
                if(boardState[r][c]?.player === 2) redCount++;
            }
            if(blueCount === 0 || redCount === 0) endGame("No pieces remaining!");
        }

        function calculateMoves(r, c, onlyCaptures = false) {
            const piece = boardState[r][c];
            if (!piece) return [];
            const moves = [];
            const dirs = [[-1, -1], [-1, 1], [1, -1], [1, 1]];
            
            if (piece.isDama) {
                dirs.forEach(d => {
                    let nr = r + d[0], nc = c + d[1];
                    let jumpedEnemy = null;
                    while (nr >= 0 && nr < 8 && nc >= 0 && nc < 8) {
                        const target = boardState[nr][nc];
                        if (!jumpedEnemy) {
                            if (!target) {
                                if (!onlyCaptures) moves.push({ r: nr, c: nc });
                            } else if (target.player !== piece.player) {
                                jumpedEnemy = { r: nr, c: nc };
                            } else break;
                        } else {
                            if (!target) moves.push({ r: nr, c: nc, capture: jumpedEnemy });
                            else break;
                        }
                        nr += d[0]; nc += d[1];
                    }
                });
            } else {
                if (!onlyCaptures) {
                    const forwardDirs = piece.player === 1 ? [[-1, -1], [-1, 1]] : [[1, -1], [1, 1]];
                    forwardDirs.forEach(d => {
                        let nr = r + d[0], nc = c + d[1];
                        if (nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && !boardState[nr][nc]) moves.push({ r: nr, c: nc });
                    });
                }
                dirs.forEach(d => {
                    let nr = r + d[0], nc = c + d[1];
                    let jr = r + d[0]*2, jc = c + d[1]*2;
                    if (jr >= 0 && jr < 8 && jc >= 0 && jc < 8 && boardState[nr][nc] && boardState[nr][nc].player !== piece.player && !boardState[jr][jc]) {
                        moves.push({ r: jr, c: jc, capture: { r: nr, c: nc } });
                    }
                });
            }
            return moves;
        }

        function getGlobalForcedCaptures() {
            const allCaptures = [];
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                if(boardState[r][c]?.player === currentPlayer) {
                    const m = calculateMoves(r, c, true).filter(move => move.capture);
                    if(m.length > 0) allCaptures.push({r, c, moves: m});
                }
            }
            return allCaptures;
        }

        function handleCellClick(r, c) {
            if (!gameActive) return;
            if (matchId && myPlayerNum !== currentPlayer) return;

            const forced = getGlobalForcedCaptures();
            const piece = boardState[r][c];

            if (currentChainCapture) {
                if (r === currentChainCapture.r && c === currentChainCapture.c) {
                    selectedPiece = { r, c };
                    validMoves = calculateMoves(r, c, true).filter(m => m.capture);
                    render();
                } else if (selectedPiece && selectedPiece.r === currentChainCapture.r) {
                    const move = validMoves.find(m => m.r === r && m.c === c);
                    if (move) executeMove(selectedPiece.r, selectedPiece.c, r, c, move.capture);
                }
                return;
            }

            if (piece && piece.player === currentPlayer) {
                if (forced.length > 0 && !forced.some(f => f.r === r && f.c === c)) return;
                selectedPiece = { r, c };
                validMoves = calculateMoves(r, c);
                if (forced.length > 0) validMoves = validMoves.filter(m => m.capture);
                render();
            } else if (selectedPiece) {
                const move = validMoves.find(m => m.r === r && m.c === c);
                if (move) executeMove(selectedPiece.r, selectedPiece.c, r, c, move.capture);
            }
        }

        async function executeMove(fR, fC, tR, tC, capture) {
            const piece = boardState[fR][fC];
            
            if (capture) {
                const enemy = boardState[capture.r][capture.c];
                const op = operators[tR][tC];
                let pts = 0;
                if (op === '+') pts = piece.val + enemy.val;
                else if (op === '-') pts = Math.abs(piece.val - enemy.val);
                else if (op === 'x') pts = piece.val * enemy.val;
                else if (op === 'รท') pts = enemy.val !== 0 ? Math.floor(piece.val / enemy.val) : 0;
                
                scores[currentPlayer] += pts * (piece.isDama ? 2 : 1);
                boardState[capture.r][capture.c] = null;
            }

            boardState[tR][tC] = piece;
            boardState[fR][fC] = null;

            if (!piece.isDama && ((currentPlayer === 1 && tR === 0) || (currentPlayer === 2 && tR === 7))) {
                piece.isDama = true;
            }

            if (capture) {
                const nextCaptures = calculateMoves(tR, tC, true).filter(m => m.capture);
                if (nextCaptures.length > 0) {
                    currentChainCapture = { r: tR, c: tC };
                    selectedPiece = currentChainCapture;
                    validMoves = nextCaptures;
                    render();
                    syncOnline();
                    return;
                }
            }

            currentChainCapture = null;
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            selectedPiece = null;
            validMoves = [];
            
            checkPieceCounts();
            render();
            syncOnline();
        }

        async function syncOnline() {
            if (matchId && db) {
                const path = `artifacts/${appId}/public/data/matches/${matchId}`;
                await db.doc(path).update({
                    board: JSON.stringify(boardState),
                    scores,
                    currentPlayer,
                    gameActive
                }).catch(e => console.error("Sync error", e));
            }
        }

        function render() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r + c) % 2 !== 0 ? 'dark' : 'light'}`;
                    cell.innerText = operators[r][c];
                    cell.onclick = () => handleCellClick(r, c);
                    
                    const p = boardState[r][c];
                    if (p) {
                        const pDiv = document.createElement('div');
                        pDiv.className = `pitsa ${p.player === 1 ? 'blue' : 'red'} ${p.isDama ? 'dama' : ''}`;
                        if (selectedPiece && selectedPiece.r === r && selectedPiece.c === c) pDiv.classList.add('selected');
                        pDiv.innerText = p.val;
                        cell.appendChild(pDiv);
                    }
                    if (validMoves.some(m => m.r === r && m.c === c)) {
                        const dot = document.createElement('div');
                        dot.className = 'move-dot';
                        cell.appendChild(dot);
                    }
                    board.appendChild(cell);
                }
            }
            document.getElementById('score1').innerText = scores[1];
            document.getElementById('score2').innerText = scores[2];
            document.getElementById('turn-text').innerText = currentPlayer === 1 ? "Blue" : "Red";
            document.getElementById('turn-box').className = `p-6 rounded-[2rem] text-center shadow-lg transition-all ${currentPlayer === 1 ? 'bg-blue-600' : 'bg-red-600'}`;
            document.getElementById('card1').className = `text-center bg-blue-50 p-3 rounded-2xl border-2 min-w-[90px] ${currentPlayer === 1 ? 'border-blue-400 scale-105' : 'border-transparent'}`;
            document.getElementById('card2').className = `text-center bg-red-50 p-3 rounded-2xl border-2 min-w-[90px] ${currentPlayer === 2 ? 'border-red-400 scale-105' : 'border-transparent'}`;
        }

        // Multiplayer logic
        window.openModal = () => document.getElementById('multiplayer-modal').style.display = 'flex';
        window.closeModal = () => document.getElementById('multiplayer-modal').style.display = 'none';
        
        async function hostGame() {
            if (!isOnline) return alert("Multiplayer unavailable: Connection failed.");
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            matchId = code; myPlayerNum = 1;
            document.getElementById('mp-controls').classList.add('hidden');
            document.getElementById('mp-waiting').classList.remove('hidden');
            document.getElementById('display-code').innerText = code;
            
            const path = `artifacts/${appId}/public/data/matches/${code}`;
            await db.doc(path).set({
                board: JSON.stringify(boardState),
                scores: { 1: 0, 2: 0 },
                currentPlayer: 1,
                status: 'waiting',
                gameActive: true
            });
            listen(code);
        }

        async function joinGame() {
            const code = document.getElementById('join-code').value.toUpperCase();
            if (code.length !== 6) return;
            matchId = code; myPlayerNum = 2;
            const path = `artifacts/${appId}/public/data/matches/${code}`;
            const ref = db.doc(path);
            const snap = await ref.get();
            if (!snap.exists) return alert("Match code not found.");
            await ref.update({ status: 'active' });
            closeModal();
            listen(code);
        }

        function listen(code) {
            const path = `artifacts/${appId}/public/data/matches/${code}`;
            db.doc(path).onSnapshot(doc => {
                const data = doc.data();
                if (!data) return;
                if (data.status === 'active') closeModal();
                boardState = JSON.parse(data.board);
                scores = data.scores;
                currentPlayer = data.currentPlayer;
                gameActive = data.gameActive;
                if (!gameActive) {
                    const winText = scores[1] > scores[2] ? "Blue" : "Red";
                    document.getElementById('winner-modal').style.display = 'flex';
                    document.getElementById('winner-title').innerText = `${winText} Wins!`;
                }
                render();
            }, err => console.error("Listener error:", err));
        }
        
        function resetGame() { location.reload(); }
        function cancelMultiplayer() { location.reload(); }
    </script>
</body>
</html>
